Index: rpc_server.c
===================================================================
RCS file: /home/wine/wine/dlls/rpcrt4/rpc_server.c,v
retrieving revision 1.30
diff -u -r1.30 rpc_server.c
--- rpc_server.c	17 Jun 2004 19:54:34 -0000	1.30
+++ rpc_server.c	8 Aug 2004 21:19:01 -0000
@@ -185,6 +185,7 @@
   return packet;
 }
 
+#ifndef __REACTOS__
 typedef struct {
   PRPC_MESSAGE msg;
   void* buf;
@@ -205,20 +206,25 @@
   TRACE("returning failure packet\n");
   return EXCEPTION_EXECUTE_HANDLER;
 }
+#endif
 
 static void RPCRT4_process_packet(RpcConnection* conn, RpcPktHdr* hdr, RPC_MESSAGE* msg)
 {
   RpcServerInterface* sif;
   RPC_DISPATCH_FUNCTION func;
+#ifndef __REACTOS__
   packet_state state;
+#endif
   UUID *object_uuid;
   RpcPktHdr *response;
   void *buf = msg->Buffer;
   RPC_STATUS status;
 
+#ifndef __REACTOS__
   state.msg = msg;
   state.buf = buf;
   TlsSetValue(worker_tls, &state);
+#endif
 
   switch (hdr->common.ptype) {
     case PKT_BIND:
@@ -305,11 +311,15 @@
                   MAKEWORD(hdr->common.drep[2], hdr->common.drep[3]));
 
       /* dispatch */
+#ifndef __REACTOS__
       __TRY {
         if (func) func(msg);
       } __EXCEPT(rpc_filter) {
         /* failure packet was created in rpc_filter */
       } __ENDTRY
+#else
+      if (func) func(msg);
+#endif
 
       /* send response packet */
       I_RpcSend(msg);
@@ -333,7 +343,9 @@
   I_RpcFreeBuffer(msg);
   msg->Buffer = NULL;
   RPCRT4_FreeHeader(hdr);
+#ifndef __REACTOS__
   TlsSetValue(worker_tls, NULL);
+#endif
 }
 
 static DWORD CALLBACK RPCRT4_worker_thread(LPVOID the_arg)
