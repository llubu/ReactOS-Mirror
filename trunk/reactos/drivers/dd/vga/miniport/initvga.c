#include <internal/i386/io.h>

#include "vgaVideo.h"

void outxay(unsigned short ad, unsigned char x, unsigned char y)
{
  unsigned short xy = (x << 8) + y;
  VideoPortWritePortUshort(ad, xy);
}

void setMode(VideoMode mode)
{
  unsigned char x;

  VideoPortWritePortUchar((PUCHAR)MISC, mode.Misc);
  VideoPortWritePortUchar((PUCHAR)STATUS, 0);
  VideoPortWritePortUchar((PUCHAR)FEATURE, mode.Feature);

  for(x=0; x<5; x++)
  {
    outxay(SEQ, mode.Seq[x], x);
  }

  VideoPortWritePortUshort((USHORT)CRTC, 0x11);
  VideoPortWritePortUshort((USHORT)CRTC, (mode.Crtc[0x11] & 0x7f));

  for(x=0; x<25; x++)
  {
    outxay(CRTC, mode.Crtc[x], x);
  }

  for(x=0; x<9; x++)
  {
    outxay(GRAPHICS, mode.Gfx[x], x);
  }

  x=VideoPortReadPortUchar(FEATURE);

  for(x=0; x<21; x++)
  {
    VideoPortWritePortUchar((PUCHAR)ATTRIB, x);
    VideoPortWritePortUchar((PUCHAR)ATTRIB, mode.Attrib[x]);
  }

  x=VideoPortReadPortUchar(STATUS);

  VideoPortWritePortUchar(ATTRIB, 0x20);
}

VideoMode Mode12 = {
    0xa000, 0xe3, 0x00,

    {0x02, 0x01, 0x0f, 0x00, 0x06},

    {0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0x0b, 0x3e, 0x00, 0x40, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x59, 0xea, 0x8c, 0xdf, 0x28, 0x00, 0xe7, 0x04, 0xe3,
     0xff},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x05, 0x0f, 0xff},

    {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,
     0x0c, 0x0d, 0x0e, 0x0f, 0x81, 0x00, 0x0f, 0x00, 0x00}
};

VideoMode Mode13 = {
    0xa000, 0x63, 0x00,

    {0x03, 0x01, 0x0f, 0x00, 0x0e},

    {0x5f, 0x4f, 0x50, 0x82, 0x54, 0x80, 0xbf, 0x1f, 0x00, 0x41, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x9c, 0x0e, 0x8f, 0x28, 0x40, 0x96, 0xb9, 0xa3,
     0xff},

    {0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0x07, 0x0f, 0xff},

    {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,
     0x0c, 0x0d, 0x0e, 0x0f, 0x41, 0x00, 0x0f, 0x00, 0x00}
};

void myvgaPutPixel(int x, int y, unsigned char c)
{
  unsigned offset;
  unsigned char a;

  offset = xconv[x]+y80[y];

  VideoPortWritePortUchar((PUCHAR)0x3ce,0x08);               // Set
  VideoPortWritePortUchar((PUCHAR)0x3cf,maskbit[x]);         // the MASK
  VideoPortWritePortUshort((PUSHORT)0x3ce,0x0205);            // write mode = 2 (bits 0,1)
                                      // read mode = 0  (bit 3
  a = vidmem[offset];                 // Update bit buffer
  vidmem[offset] = c;                 // Write the pixel
}

void InitVGAMode()
{
//   vidmem += __djgpp_conventional_base;

   setMode(Mode12);
   RtlZeroMemory(vidmem, 38400);
   vgaPreCalc();
}
